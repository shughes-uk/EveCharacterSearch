{% extends "base.html" %}
{% load humanize %}
{% block title %} Home{% endblock %}
{% block extra_js %}
<link href="{{ STATIC_URL }}images/favicon.ico" rel="icon" type="image/x-icon">

<script>
	var skillList = {{ js_skills|safe }}
	var filterList = {{ js_filters|safe }}
	var counter = 1
	function delself(){
		parentNode.parentNode.removeChild(parentNode)
	}
	function makeSkillSelectElement(typeID,name,selected)	{
		var skillEle = document.createElement('option');
		skillEle.value = typeID;
		skillEle.innerHTML = name;
		if (selected)
		{
			skillEle.selected = true;
		}
		return skillEle;
	}
	function start() {
		for (var i = 0; i < filterList.length; i++)
		{
			delbutton = makeDelButton()
			opBox = makeOperandsBox(counter,filterList[i].operandSelect)
			var optionsDiv = document.createElement('span')
			optionsDiv.setAttribute('filter_number',counter)
			var mainDiv = document.createElement('div')
			if (filterList[i].sp_million)
			{
				filterType = makeFilterTypeSelect('sp')
				spBox = makeSPBox(counter,filterList[i].sp_million)
				optionsDiv.appendChild(filterType)
				optionsDiv.appendChild(opBox)
				optionsDiv.appendChild(spBox)	
			}
			else if(filterList[i].level_box)
			{
				filterType = makeFilterTypeSelect('skill')
				catBox = makeSkillCatBox(counter,filterList[i].skill_cat)
				skillBox = makeSkillBox(counter,filterList[i].skill_cat,filterList[i].skill_typeID)
				levelBox = makeLevelBox(counter,parseInt(filterList[i].level_box))
				optionsDiv.appendChild(filterType)
				optionsDiv.appendChild(catBox)
				optionsDiv.appendChild(skillBox)
				optionsDiv.appendChild(opBox)
				optionsDiv.appendChild(levelBox)
			}
			mainDiv.insertBefore(document.createElement('br'),mainDiv.firstChild);
			mainDiv.insertBefore(delbutton,mainDiv.firstChild);
			mainDiv.insertBefore(optionsDiv,mainDiv.firstChild)
			document.forms.filters.insertBefore(mainDiv,document.forms.filters.lastElementChild);
			if (counter % 2 == 1)
			{
				mainDiv.setAttribute('class','div_odd')
			}
			else
			{
				mainDiv.setAttribute('class','div_even')
			}
			counter++
		}
		
	}
	function addFilter() {		
		delbutton = makeDelButton()
		filterType = makeFilterTypeSelect('skill')
		catBox = makeSkillCatBox(counter,'266')
		opBox = makeOperandsBox(counter)
		skillBox = makeSkillBox(counter,'266','11584')
		levelBox = makeLevelBox(counter)
		var optionsDiv = document.createElement('span')
		optionsDiv.appendChild(filterType,optionsDiv.firstChild);
		optionsDiv.appendChild(catBox,optionsDiv.firstChild);
		optionsDiv.appendChild(skillBox,optionsDiv.firstChild);
		optionsDiv.appendChild(opBox,optionsDiv.firstChild);
		optionsDiv.appendChild(levelBox,optionsDiv.firstChild);		
		optionsDiv.setAttribute('filter_number',counter)
		var div = document.createElement('div');
		div.insertBefore(document.createElement('br'),div.firstChild);
		div.insertBefore(delbutton,div.firstChild);
		div.insertBefore(optionsDiv,div.firstChild)
		document.forms.filters.insertBefore(div,document.forms.filters.lastElementChild);
		if (counter % 2 == 1)
		{
			div.setAttribute('class','div_odd')
		}
		else
		{
			div.setAttribute('class','div_even')
		}
		counter++;
	}
	function makeSkillCatBox(fNumber,selectedID){
		var skillCatSelect = document.createElement('select');
		skillCatSelect.name = "('skill_cat'," + fNumber + ')';
		skillCatSelect.setAttribute('onChange','onSkillCatChange(this)');
		var catList = new Array();
		for (var i = 0; i < skillList.length; i++) 
		{    			
			if (catList.indexOf(skillList[i]['fields']['groupName']) != -1)
			{
				continue;
			}
			else
			{
				catList.push(skillList[i]['fields']['groupName']);
				var catOption = document.createElement('option');
				catOption.value = skillList[i]['fields']['groupID'];
				catOption.innerHTML = skillList[i]['fields']['groupName'];
				skillCatSelect.options.add(catOption);
				if (selectedID == skillList[i]['fields']['groupID'])
				{
					catOption.selected = true;

				}
			}
		} 
		return skillCatSelect;
	}
	function makeSPBox(fNumber,selected){
		var spSelect = document.createElement('select');
		spSelect.name = "('sp_million'," + fNumber + ')';
		spSelect.setAttribute('filter_number',fNumber)
		for(var i=1;i<=200;i++)
		{
			var newOption = document.createElement('option');
			newOption.value = i;
			newOption.innerHTML= i +'M';
		    spSelect.options.add(newOption);
		    if (i == selected)
		    {
		    	newOption.selected = true;
		    }
	    }
	    return spSelect
	}
	function makeDelButton(){
		var delbutton = document.createElement('button');
		delbutton.setAttribute('onclick','parentNode.parentNode.removeChild(parentNode)');
		delbutton.innerHTML = 'Remove Filter';
		delbutton.type = 'button'
		return delbutton
	}

	function makeFilterTypeSelect(selectedType){
		var filterType = document.createElement('select');
		filterType.name = 'filterType';
		filterType.setAttribute('num', counter);
		filterType.setAttribute('onChange','onFilterTypeChange(this)');
		var sp = document.createElement('option');
		sp.value = 'sp';
		sp.innerHTML = 'SP';
		filterType.appendChild(sp)
		var skill = document.createElement('option');
		skill.value = 'skill';
		skill.innerHTML = 'Skill'
		filterType.appendChild(skill)
		if (selectedType == 'skill')
		{
			skill.selected = true;
		}
		return filterType;
	}
	function makeOperandsBox(fNumber,selectedType){
		var operandSelect = document.createElement('select');
		operandSelect.name = "('operandSelect'," + fNumber + ')';
		operandSelect.setAttribute('filter_number',fNumber);
		var geEq = document.createElement('option');
		geEq.value = '>=';
		geEq.innerHTML = 'Greater than';
		var leEq = document.createElement('option');
		leEq.value = '<=';
		leEq.innerHTML = 'Less than';
		var eq = document.createElement('option');
		eq.value = '==';
		eq.innerHTML = 'Exactly';
		operandSelect.appendChild(geEq);
		operandSelect.appendChild(leEq);
		operandSelect.appendChild(eq);
		if (selectedType =='>=')
		{
			geEq.selected = true
		}
		if (selectedType == '<=')
		{
			leEq.selected = true
		}
		if (selectedType == '==')
		{
			eq.selected = true
		}
		return operandSelect;
	}
	function onFilterTypeChange(ele){
		filterDiv = ele.parentNode;
		while (filterDiv.firstChild){
			if (filterDiv.childNodes.length > 1){
				if (filterDiv.firstChild != ele){
					filterDiv.removeChild(filterDiv.firstChild)
				}
				else{
					filterDiv.removeChild(filterDiv.lastChild)
				}
			}
			else{
				break
			} 	
    	}
    	selectedType = ele.options[ele.selectedIndex].value;
    	if (selectedType == 'sp')
    	{
    		spBox = makeSPBox(filterDiv.getAttribute('filter_number'));
    		operandBox = makeOperandsBox(filterDiv.getAttribute('filter_number'));
    		filterDiv.appendChild(operandBox);
    		filterDiv.appendChild(spBox);

    	}
    	else
    	{
    		skillCatBox = makeSkillCatBox(filterDiv.getAttribute('filter_number'));
    		filterDiv.appendChild(skillCatBox);
    		onSkillCatChange(skillCatBox);
    	}
	}
	function makeSkillBox(fNumber , groupID , selectedID){
		var skillBox = document.createElement('select');
		skillBox.name = "('skill_typeID'," + fNumber + ')';
		skillBox.setAttribute('filter_number' , fNumber);
		for (var i = 0; i < skillList.length; i++) 
		{    			
			if (skillList[i]['fields']['groupID'] == groupID)
			{
				var skillOption = document.createElement('option');
				skillOption.value = skillList[i]['fields']['typeID'];
				skillOption.innerHTML = skillList[i]['fields']['name'];
				skillBox.options.add(skillOption);
				if (skillList[i]['fields']['typeID'] == selectedID)
				{
					skillOption.selected  = true;
				}
			}
		} 
		return skillBox;
	}
	function makeLevelBox(fNumber , selected){
		var levelBox = document.createElement('select');
		levelBox.name = "('level_box'," + fNumber + ')';
		levelBox.setAttribute('filter_number',fNumber);

		var one = document.createElement('option');
		one.value = '1';
		one.innerHTML = 'I';
		levelBox.appendChild(one)
		var two = document.createElement('option');
		two.value = '2';
		two.innerHTML = 'II';
		levelBox.appendChild(two);
		var three = document.createElement('option');
		three.value = '3';
		three.innerHTML = 'III';
		levelBox.appendChild(three);
		var four = document.createElement('option');
		four.value = '4';
		four.innerHTML = 'IV';
		levelBox.appendChild(four);
		var five = document.createElement('option');
		five.value = '5';
		five.innerHTML = 'V';
		levelBox.appendChild(five);
		switch(selected)
		{
			case 1:
				one.selected = true;
				break;
			case 2:
			  	two.selected = true;
			  	break;
			case 3:
				three.selected = true;
				break;
			case 4:
				four.selected = true;
				break;
			case 5:
				five.selected = true;
				break;
			default:
				break;
		}
		return levelBox
	}
	function onSkillCatChange(ele){
		var fNumber = ele.parentNode.getAttribute('filter_number');
		var groupID = ele.options[ele.selectedIndex].value;
		while (ele.parentNode.lastChild)
		{
			if (ele.parentNode.lastChild != ele)
			{
				ele.parentNode.removeChild(ele.parentNode.lastChild);
			}
			else
			{
				break
			}
		}
		ele.parentNode.appendChild(makeSkillBox(fNumber,groupID));
		ele.parentNode.appendChild(makeOperandsBox(fNumber));
		ele.parentNode.appendChild(makeLevelBox(fNumber));		

	}


	window.onload = start
 </script>
 {% endblock %}
{% block content %}
	<h1 class='center'>Eve Character Search Alpha 0.25</h1>
	 
	 <form class='center' name='filters' method='post'>
	 	{% csrf_token %}
	 	<div class='center'><button type='button' onclick='addFilter()'>Add Filter</button></div>
	 	<input type='submit' value='Search'/>
	 </form>
	<br>
	{% if threads %}
			<table class='center'>
				<tr>
					<th scope="col">Thread</th>
					<th scope="col">Total SP</th>
					<th scope="col">Last Seen</th>
					<th scope="col">Eveboard Link</th>
				<tr>
				{% for thread in threads %}
				    <tr>
				    	<td>
				    		<a href="https://forums.eveonline.com/default.aspx?g=posts&t={{ thread.thread_id }}&find=unread">{{ thread.thread_title }}</a>
				    	</td>
				    	<td>
				    		{% filter intcomma %}
				    		{{ thread.character.total_sp}}
				    		{% endfilter %}
				    	</td>
				    	<td>
				    		{{ thread.last_update }}
				    	</td>
				    	<td align='center'>
				        	<a href="http://eveboard.com/pilot/{{ thread.character.name }}"><img src="{{ STATIC_URL }}images/eveboard.jpg" alt='Eveboard link'/></a>
				        </td>
				    </tr>
			    {% endfor %}
		    </table>
	{% else %}
	<div class='center' style='background-color:#C2C2B2'>
	No search results, add a filter to get started or adjust your current ones
	</div>
	{% endif %}
	</br>
	</br>
	<div class='center'>
		<h2> Notes </h2>
		<ul style='text-align:left'>
		    <li>This app scrapes the eve-o forum character bazaar and builds a database of currently active sales</li>
		    <li>You add filters then hit search to find the character with the skills you want</li>
		    <li>Currently It wont scrape passworded sales</li>
		    <li>At the moment it searchs for the skills you put in or greater than</li>
		    <li>Contact twistfrog on jabber if you have anything to say</li>
		</ul>
		<h2>Changelog</h2>
		<h3>18/04/2013 - v0.25</h3>
		<ul style='text-align:left'>
			<li>Added explantion if there are no search results</li>
			<li>Reordered the operand box so put 'exactly' as the last option as it doesn't really work for SP totals and was confusing people</li>
			<li>Bugfix : Remember SP amount selected</li>
		</ul>
		<h3>16/04/2013 - v0.2</h3>
		<ul style='text-align:left'>
			<li>Now storing your searches via cookies</li>
			<li>Search by total skillpoints</li>
			<li>Operands for searching!</li>
			<li>More javascript changes , filters are created entirely in JS now</li>
			<li>Total SP table coloumn</li>
			<li>Probably introduced a bunch of bugs</li>
		</ul>

		<h3>18/02/2013 - v0.1</h3>
		<ul style='text-align:left'>
			<li>Added 'Last seen' column to indicate when the thread was last seen on the front page</li>
			<li>Sorted skills roughly as they are sorted ingame</li>
			<li>Big optimizations for the javascript.. no more 20k autogenerated javascript lines</li>
			<li>Persist filters so you don't lose your filterset when you press search!</li>
			<li>Remove filter button</li>
		</ul>
		<h3>01/12/2012 - v0.000000000002 </h3>
			<ul style='text-align:left'>
				<li>Initial version</li>
			</ul>


	</div>
 {% endblock %}
